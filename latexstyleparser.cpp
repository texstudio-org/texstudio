#include "latexstyleparser.h"

LatexStyleParser::LatexStyleParser(QObject *parent,QString baseDirName) :
    QThread(parent)
{
    baseDir=baseDirName;
    stopped=false;
    mFiles.clear();
}

void LatexStyleParser::stop(){
	stopped=true;
	mFilesAvailable.release();
}

void LatexStyleParser::run(){
	forever {
		//wait for enqueued lines
		mFilesAvailable.acquire();
		if(stopped) break;
		mFilesLock.lock();
		QString fn=mFiles.dequeue();
		mFilesLock.unlock();
		QFile data(fn);
		QStringList results;
		if(data.open(QFile::ReadOnly)){
			QTextStream stream(&data);
			QString line;
			QRegExp rxDef("\\\\def\\s*(\\\\[\\w@]+)\\s*(#\\d+)?");
			QRegExp rxCom("\\\\(newcommand|providecommad)\\s*\\{(\\\\\\w+)\\}\\s*\\[?(\\d+)?\\]?");
			while(!stream.atEnd()) {
			    line = stream.readLine();
			    int options=0;
			    if(rxDef.indexIn(line)>-1){
				QString name=rxDef.cap(1);
				if(name.contains("@"))
				    continue;
				QString optionStr=rxDef.cap(2);
				//qDebug()<< name << ":"<< optionStr;
				options=optionStr.mid(1).toInt(); //returns 0 if conversion fails
				for (int j=0; j<options; j++) {
				    name.append(QString("{arg%1}").arg(j+1));
				}
				name.append("#*");
				if(!results.contains(name))
				    results << name;
				continue;
			    }
			    if(rxCom.indexIn(line)>-1){
				QString name=rxCom.cap(2);
				if(name.contains("@"))
				    continue;
				QString optionStr=rxCom.cap(3);
				//qDebug()<< name << ":"<< optionStr;
				options=optionStr.toInt(); //returns 0 if conversion fails
				for (int j=0; j<options; j++) {
				    name.append(QString("{arg%1}").arg(j+1));
				}
				name.append("#*");
				if(!results.contains(name))
				    results << name;
				continue;
			    }

			}
		}
		if(!results.isEmpty()){
		    QFileInfo info(fn);
		    QString baseName=info.completeBaseName();
		    if(!baseName.isEmpty()){
			QFile data(baseDir+"/"+baseName+".cwl");
			if(data.open(QFile::WriteOnly|QFile::Truncate)){
			    QTextStream out(&data);
			    out << "# autogenerated by tmx\n";
			    foreach(QString elem,results){
				out << elem << "\n";
			    }
			}
			emit scanCompleted(baseName);
		    }
		}
	}
}

void LatexStyleParser::addFile(QString filename){
	mFilesLock.lock();
	mFiles.enqueue(filename);
	mFilesLock.unlock();
	mFilesAvailable.release();
}
