name: CD
on:
  - push
  - pull_request

permissions:
  contents: read

jobs:
  build-win10:
    name: win10 build (msys2)
    if: github.event_name == 'push'
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v3
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: | 
            git make mingw-w64-ucrt-x86_64-cmake mingw-w64-ucrt-x86_64-toolchain mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-qt6-base mingw-w64-ucrt-x86_64-qt6-declarative 
            mingw-w64-ucrt-x86_64-qt6-svg mingw-w64-ucrt-x86_64-qt6-5compat  
            mingw-w64-ucrt-x86_64-qt6-tools mingw-w64-ucrt-x86_64-poppler-qt6 
            mingw-w64-ucrt-x86_64-nsis mingw-w64-ucrt-x86_64-quazip-qt6 
            mingw-w64-ucrt-x86_64-hunspell mingw-w64-ucrt-x86_64-qt6-translations 
            mingw-w64-ucrt-x86_64-python-mingw-ldd zip unzip

      - name: Fetch tag annotations
        run: git fetch --tags --force

      - name: Configure
        run: |
          mkdir build
          cd build
          . ../.github/scripts/get-version.sh
          sed -i ../win.rc -Ee "s/0,[0,]+/$(tr <<<"$TXS_VERSION" . ,),0/"
          sed -i ../win.rc -e "s/git[\]0/$VERSION_NAME/"
          # qmake-qt6 texstudio.pro CONFIG-=debug MXE=1 BUILD_ADWAITA=1 STRIP=1
          cmake .. -Wno-dev
          # work-around strange git behaviour on msys2
          . ../git_revision.sh
      - name: Build
        run: |
          cd build
          cmake --build . -- -j 2
      - name: Package
        id: package
        run: |
          cd build
          . ../.github/scripts/get-version.sh
          . ../.github/scripts/package_msys.sh
          echo "VERSION_NAME=${VERSION_NAME}">> $GITHUB_OUTPUT
          echo "TXS_VERSION=${TXS_VERSION}">> $GITHUB_OUTPUT
          echo "GIT_VERSION=${GIT_VERSION}">> $GITHUB_OUTPUT

      - name: Upload zip to GitHub Artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v3
        with:
          name: texstudio-win-qt6-zip
          path: ./build/package-zip/texstudio-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.zip
          
      - name: Upload to GitHub Artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v3
        with:
          name: texstudio-win-qt6-exe
          path: texstudio-win-qt6-${{ steps.package.outputs.VERSION_NAME }}.exe

      - name: Upload release file(s)
        uses: actions/upload-artifact@v3
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: release
          path: |
            texstudio-${{ steps.package.outputs.GIT_VERSION }}-win-qt6.exe
            texstudio-${{ steps.package.outputs.GIT_VERSION }}-win-portable-qt6.zip

###################################

  build-windows-arm64:
    name: windows on arm64 build (cross compile with MSVC)
    if: github.event_name == 'push'
    runs-on: windows-latest
    env:
      qt_version: "6.4.1"

    steps:
      - uses: actions/checkout@v3

      - name: Fetch tag annotations
        run: git fetch --tags --force

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: true
          install: | 
            git zip

      - name: Set up MSVC develop environment
        uses: ilammy/msvc-dev-cmd@v1.4.1
        with:
          arch: amd64_arm64

      - name: Build dependencies with vcpkg
        uses: johnwason/vcpkg-action@v3
        with:
          pkgs: zlib tiff openjpeg libpng liblzma libjpeg-turbo libiconv freetype bzip2 brotli lcms boost-winapi boost-type-traits boost-type-traits boost-throw-exception boost-static-assert boost-preprocessor boost-predef boost-move boost-intrusive boost-integer boost-detail boost-core boost-container-hash boost-container boost-config boost-assert
          triplet: arm64-windows
          revision: '2022.11.14'
          
      - name: Install Qt (host x64)
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: '==2.1.*'
          version: '${{ env.qt_version }}'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qt5compat'
          dir: '${{ github.workspace }}'
          set-env: 'false'

      - name: Install Qt (arm64)
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: '==2.1.*'
          version: '${{ env.qt_version }}'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_arm64'
          modules: 'qtimageformats qt5compat'
          dir: '${{ github.workspace }}'
          set-env: 'false'

      - name: Build TexTablet
        run: |
          git clone https://github.com/stevenlovegrove/TexTablet.git
          cd TexTablet
          git apply ../.github/scripts/textable-vs2022-dotnet48.patch
          MSBuild /property:Configuration=Release /property:Platform=ARM64

      - name: Build poppler
        run: |
          $work_dir = '${{ github.workspace }}'
          $pattern = '[\\]'
          $work_dir = $work_dir -replace $pattern, '/'
          $poppler_ver = "22.11.0"
          $poppler_url = "https://poppler.freedesktop.org/poppler-$poppler_ver.tar.xz"
          Invoke-WebRequest -Uri $poppler_url -OutFile poppler-$poppler_ver.tar.xz
          7z.exe x poppler-$poppler_ver.tar.xz
          tar -xf poppler-$poppler_ver.tar
          Set-Location poppler-$poppler_ver
          cmake -G "Ninja" -DCMAKE_INSTALL_PREFIX="$work_dir/poppler" -DCMAKE_BUILD_TYPE=Release -DENABLE_QT5=OFF -DENABLE_QT6=ON -DCMAKE_TOOLCHAIN_FILE="$work_dir/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=arm64-windows -DCMAKE_PREFIX_PATH="$work_dir/Qt/${{ env.qt_version }}/msvc2019_arm64" -DQT_HOST_PATH="$work_dir/Qt/${{ env.qt_version }}/msvc2019_64" .
          cmake --build .
          cmake --install .

      - name: Install poppler-data
        run: |
          $poppler_data_ver = "0.4.11"
          $poppler_data_url = "https://poppler.freedesktop.org/poppler-data-$poppler_data_ver.tar.gz"
          Invoke-WebRequest -Uri $poppler_data_url -OutFile poppler-data-$poppler_data_ver.tar.gz
          tar -xf poppler-data-$poppler_data_ver.tar.gz
          Set-Location poppler-data-$poppler_data_ver
          cmake -G "Ninja" -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/poppler -DCMAKE_BUILD_TYPE=Release 
          cmake --build .
          cmake --install .

      - name: Configure TeXstudio
        run: |
          $work_dir = '${{ github.workspace }}'
          $pattern = '[\\]'
          $work_dir = $work_dir -replace $pattern, '/'
          Set-Content -Path ".\CMakeLists.txt" -Value (get-content -Path ".\CMakeLists.txt" | Select-String -Pattern 'Wno-deprecated-declarations' -NotMatch)
          mkdir ./build
          Set-Location ./build
          cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$work_dir/vcpkg/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=arm64-windows -DCMAKE_PREFIX_PATH="$work_dir/Qt/${{ env.qt_version }}/msvc2019_arm64;$work_dir/poppler" -DQT_HOST_PATH="$work_dir/Qt/${{ env.qt_version }}/msvc2019_64" ..

      - name: Configure version
        shell: msys2 {0}
        run: | 
          cd build  
          . ../.github/scripts/get-version.sh
          sed -i ../win.rc -Ee "s/0,[0,]+/$(tr <<<"$TXS_VERSION" . ,),0/"
          sed -i ../win.rc -e "s/git[\]0/$VERSION_NAME/"
          . ../git_revision.sh

      - name: Build TeXstudio
        run: |
          Set-Location build
          cmake --build .

      - name: Package
        id: package
        shell: msys2 {0}
        run: |
          export qt_ver=${{ env.qt_version }}
          cd build
          . ../.github/scripts/get-version.sh
          cd ..
          . ./.github/scripts/package_win_arm64.sh
          echo "VERSION_NAME=${VERSION_NAME}">> $GITHUB_OUTPUT
          echo "TXS_VERSION=${TXS_VERSION}">> $GITHUB_OUTPUT
          echo "GIT_VERSION=${GIT_VERSION}">> $GITHUB_OUTPUT

      - name: Upload zip to GitHub Artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v3
        with:
          name: texstudio-win-arm64-qt6-zip
          path: ./package-zip/texstudio-win-arm64-qt6-${{ steps.package.outputs.VERSION_NAME }}.zip

      - name: Upload release file(s)
        uses: actions/upload-artifact@v3
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: release
          path: |
            texstudio-${{ steps.package.outputs.GIT_VERSION }}-win-arm64-portable-qt6.zip

###################################

  build-linux-release:
    name: linux appimage
    if: github.event_name == 'push'
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch tag annotations
      run: git fetch --tags --force

    - name: Updates
      run: sudo apt-get update

    - name: Dependencies
      run: sudo apt-get install qtbase5-dev qt5-default qt5-qmake libqt5svg5-dev qtdeclarative5-dev qttools5-dev libqt5svg5-dev libpoppler-qt5-dev libpoppler-cpp-dev pkg-config zlib1g-dev libquazip5-dev 

    - name: Configure
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_INSTALL_PREFIX=appdir/usr .. -Wno-dev

    - name: Build
      run: |
        cd build
        cmake --build . --target install -- -j 2
      
    - name: Package
      id: package
      run: |
        cd build
        POPPLERDATA_VERSION="0.4.8"
        POPPLERDATA_SUBDIR="poppler-data-${POPPLERDATA_VERSION}"
        POPPLERDATA_FILE="poppler-data-${POPPLERDATA_VERSION}.tar.gz"
        POPPLERDATA_URL="https://poppler.freedesktop.org/${POPPLERDATA_FILE}"
        POPPLERDATA_SHA256="1096a18161f263cccdc6d8a2eb5548c41ff8fcf9a3609243f1b6296abdf72872"
        . ../.github/scripts/package_linux.sh
        echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "TXS_VERSION=${TXS_VERSION}" >> $GITHUB_OUTPUT
        echo "GIT_VERSION=${GIT_VERSION}" >> $GITHUB_OUTPUT
        
    - name: Upload to Github Artifacts
      if: github.event_name == 'push'
      uses: actions/upload-artifact@v3
      with:
        name: texstudio-linux
        path: texstudio-linux-${{ steps.package.outputs.VERSION_NAME }}-x86_64.AppImage

    - name: Upload release file(s)
      uses: actions/upload-artifact@v3
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: release
        path: texstudio-${{ steps.package.outputs.GIT_VERSION }}-x86_64.AppImage


############################

  macosx:
    name: Mac OS X
    if: true
    runs-on: macos-11

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch tag annotations
      run: git fetch --tags --force

    - name: Install Dependencies
      run: |
        wget https://github.com/sunderme/homebrew-qt6/releases/download/6.4.1/QtBase-6.4.1-Darwin.tar.xz
        sudo tar xvf ./QtBase-6.4.1-Darwin.tar.xz -C /usr/local
        rm QtBase-6.4.1-Darwin.tar.xz
        wget https://github.com/sunderme/homebrew-qt6-modules/releases/download/6.4.1/QtSvg-6.4.1-Darwin.tar.xz
        sudo tar xvf ./QtSvg-6.4.1-Darwin.tar.xz -C /usr/local/QtBase-6.4.1-Darwin --strip-components=1
        rm QtSvg-6.4.1-Darwin.tar.xz
        wget https://github.com/sunderme/homebrew-qt6-modules/releases/download/6.4.1/Qt5Compat-6.4.1-Darwin.tar.xz
        sudo tar xvf ./Qt5Compat-6.4.1-Darwin.tar.xz -C /usr/local/QtBase-6.4.1-Darwin --strip-components=1
        rm Qt5Compat-6.4.1-Darwin.tar.xz
        wget https://github.com/sunderme/homebrew-qt6-modules/releases/download/6.4.1/QtTools-6.4.1-Darwin.tar.xz
        sudo tar xvf ./QtTools-6.4.1-Darwin.tar.xz -C /usr/local/QtBase-6.4.1-Darwin --strip-components=1
        rm QtTools-6.4.1-Darwin.tar.xz
        wget https://github.com/sunderme/homebrew-qt6-modules/releases/download/6.4.1/QtDeclarative-6.4.1-Darwin.tar.xz
        sudo tar xvf ./QtDeclarative-6.4.1-Darwin.tar.xz -C /usr/local/QtBase-6.4.1-Darwin --strip-components=1
        rm QtDeclarative-6.4.1-Darwin.tar.xz
        wget https://github.com/sunderme/homebrew-qt6-modules/releases/download/6.4.1/poppler-22.12.0-Darwin.tar.xz
        sudo tar xvf ./poppler-22.12.0-Darwin.tar.xz -C /usr/local/QtBase-6.4.1-Darwin --strip-components=1
        rm poppler-22.12.0-Darwin.tar.xz
        wget https://github.com/sunderme/homebrew-qt6-modules/releases/download/6.4.1/QuaZip-1.3-Darwin.tar.xz
        sudo tar xvf ./QuaZip-1.3-Darwin.tar.xz -C /usr/local/QtBase-6.4.1-Darwin --strip-components=1
        rm QuaZip-1.3-Darwin.tar.xz
        brew install cairo fontconfig freetype gettext jpeg libpng libtiff little-cms2 nspr nss openjpeg
        brew install ninja

    - name: Configure
      run: |
        mkdir build
        cd build
        /usr/local/QtBase-6.4.1-Darwin/bin/qt-cmake .. -G Ninja

    - name: Build
      run: |
        cd build
        cmake --build . --parallel

    - name: Workarounds
      run: |
        cd build
        mkdir -p texstudio.app/Contents/Frameworks
        cp /usr/local/lib/libbrotlicommon.1.dylib texstudio.app/Contents/Frameworks

    - name: Package
      id: package
      run: |
        cd build
        /usr/local/QtBase-6.4.1-Darwin/bin/macdeployqt texstudio.app -dmg
        . ../.github/scripts/get-version.sh
        cp texstudio.dmg ../texstudio-${GIT_VERSION}-osx.dmg
        mv texstudio.dmg ../texstudio-osx-${VERSION_NAME}.dmg
        echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
        echo "TXS_VERSION=${TXS_VERSION}" >> $GITHUB_OUTPUT
        echo "GIT_VERSION=${GIT_VERSION}" >> $GITHUB_OUTPUT
        
    - name: Upload to Github artifacts
      if: github.event_name == 'push'
      uses: actions/upload-artifact@v3
      with:
        name: texstudio-osx
        path: texstudio-osx-${{ steps.package.outputs.VERSION_NAME }}.dmg

    - name: Upload release file(s)
      uses: actions/upload-artifact@v3
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: release
        path: texstudio-${{ steps.package.outputs.GIT_VERSION }}-osx.dmg

  release:
    permissions:
      contents: write  # for softprops/action-gh-release to create GitHub release
    name: Release
    needs: [build-win10, build-linux-release, macosx] # build-linux-win,macosx-qt5 is disabled
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Download temp artifact
      uses: actions/download-artifact@v3
      with:
        name: release

    - name: Calculate hashes
      run: |
        echo --SHA1SUM-- > hashes.txt
        sha1sum * | grep -v hashes.txt >> hashes.txt
        echo >> hashes.txt
        echo --SHA256SUM-- >> hashes.txt
        sha256sum * | grep -v hashes.txt >> hashes.txt

    - name: Batch release
      uses: softprops/action-gh-release@v1
      with:
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        files: ./*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUBTOKEN }}

    - name: Delete temp artifact
      uses: GeekyEggo/delete-artifact@v2.0.0
      with:
        name: release
